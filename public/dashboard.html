<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none">
        <meta http-equiv="Cross-Origin-Opener-Policy" content="unsafe-none">
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Bootstrap Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
        <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
        <style>
            body {
                padding: 20px;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                font-weight: 400;
                line-height: 1.6;
            }
            .btn {
                margin-right: 10px;
            }
            .modal-body input {
                width: 100%;
            }
            .table th, .table td {
                vertical-align: middle;
            }
            .mb-4 {
                margin-top: 70px;
            }
            hr {
                border-top: 2px solid #000; /* Example: Bootstrap blue */
                opacity: 1;
            }
            textarea {
                height: 100px;
                border: 1px solid #000 !important;
            }
            .productCheckbox {
                cursor: pointer;
                transform: scale(1.2);
            }
            .table tr.selected {
                background-color: #e3f2fd !important;
            }
            .table tr:hover {
                background-color: #f8f9fa;
            }
            .product-image {
                width: 50px;
                height: 50px;
                object-fit: cover;
                border-radius: 4px;
                border: 1px solid #ddd;
            }
            .no-image {
                color: #999;
                font-style: italic;
                font-size: 0.9em;
            }
            #loadingRow {
                background-color: #f8f9fa;
            }
            #loadingRow td {
                padding: 2rem !important;
            }
            
            /* Beautiful typography enhancements */
            h1, h2, h3, h4, h5, h6 {
                font-weight: 600;
                letter-spacing: -0.025em;
            }
            
            .table th {
                font-weight: 600;
                font-size: 0.9em;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: #6c757d;
            }
            
            .btn {
                font-weight: 500;
                letter-spacing: 0.025em;
            }
            
            .form-control {
                font-family: inherit;
            }
            
            /* Price guide flag styles */
            .price-flag {
                display: inline-block;
                margin-left: 8px;
                padding: 2px 6px;
                border-radius: 12px;
                font-size: 0.85em;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .price-flag.has-guide {
                color: #155724;
            }
            
            .price-flag.no-guide {
                color: #ff0019;
            }
            
            .price-flag.has-guide::before {
                content: "✓ ";
            }
            
            .price-flag.no-guide::before {
                content: "⚠ ";
            }
            
            /* Filter section styling */
            .filter-section {
                background-color: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 15px;
                border: 1px solid #dee2e6;
            }
            
            .filter-counter {
                font-size: 0.9em;
                color: #6c757d;
                margin-left: 15px;
            }
            
            .filter-counter strong {
                color: #212529;
            }
        </style>
    </head>
    <body>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerModal">Create Customer</button>
        <label class="btn btn-primary mb-0">
            Select xlsx File
            <input type="file" id="xlsxFileInput" accept=".xlsx" style="display:none" onchange="handleXlsxUpload(event)">
        </label>
        <button id="refreshBackendBtn" class="btn btn-danger" onclick="dataInitial()" style="position: absolute; left: 50%; transform: translateX(-50%);">Refresh backend data</button>
        <button class="btn btn-primary" onclick="downloadExcel()" style="float: right;">Download</button>
        <div id="dashboard"></div>
        <!-- Bootstrap Modal -->
        <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="customerModalLabel">Create Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input id="customerName" class="form-control"></input>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomerFromModal()" data-bs-dismiss="modal">Save</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Password Modal for Initial Data -->
        <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="passwordModalLabel">Enter Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="passwordInput" class="form-label">Password:</label>
                  <input type="password" id="passwordInput" class="form-control" placeholder="Enter password" onkeypress="handlePasswordKeypress(event)">
                </div>
                <div id="passwordError" class="alert alert-danger" style="display: none;"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="validatePassword()">Initialize Data</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            function dataInitial() {
                // Show password modal
                var passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
                passwordModal.show();
                
                // Focus on password input when modal is shown
                document.getElementById('passwordModal').addEventListener('shown.bs.modal', function () {
                    document.getElementById('passwordInput').focus();
                });
                
                // Clear error message when modal is shown
                document.getElementById('passwordError').style.display = 'none';
            }
            
            function handlePasswordKeypress(event) {
                if (event.key === 'Enter') {
                    validatePassword();
                }
            }
            
            function validatePassword() {
                var passwordInput = document.getElementById('passwordInput');
                var passwordError = document.getElementById('passwordError');
                var enteredPassword = passwordInput.value;
                
                // Define the correct password (you can change this)
                var correctPassword = "admin123"; // Change this to your desired password
                
                if (enteredPassword === correctPassword) {
                    // Hide the modal
                    var passwordModal = bootstrap.Modal.getInstance(document.getElementById('passwordModal'));
                    passwordModal.hide();
                    
                    // Clear the password field
                    passwordInput.value = '';
                    passwordError.style.display = 'none';
                    
                    // Execute the initial data function
                    executeDataInitial();
                } else {
                    // Show error message
                    passwordError.textContent = 'Incorrect password. Please try again.';
                    passwordError.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }
            
            function executeDataInitial() {
                // Disable button and show loading state
                var refreshBtn = document.getElementById('refreshBackendBtn');
                var originalText = refreshBtn.innerHTML;
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
                refreshBtn.classList.add('disabled');
                
                fetch('/initial', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    // Re-enable button
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.classList.remove('disabled');
                    
                    // Show success notification
                    if (data.success) {
                        showNotification('✅ Backend data refreshed successfully!', 'success');
                    } else {
                        showNotification('❌ ' + (data.message || 'Error refreshing backend data'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Re-enable button
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.classList.remove('disabled');
                    
                    // Show error notification
                    showNotification('❌ Error loading initial data. Please try again.', 'error');
                });
            }
            
            function showNotification(message, type) {
                // Create notification element
                var notification = document.createElement('div');
                notification.className = 'alert alert-' + (type === 'success' ? 'success' : 'danger') + ' alert-dismissible fade show';
                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                notification.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Add to body
                document.body.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(function() {
                    if (notification.parentNode) {
                        notification.classList.remove('show');
                        setTimeout(function() {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 150);
                    }
                }, 5000);
            }

            var customers = [];
            var customerId = 1;
            var dashboard = document.getElementById('dashboard');
            
            // Pagination state for each customer
            var paginationState = {};
            function saveCustomerFromModal() {
                var customerName = document.getElementById('customerName').value;
                if (!customerName) {
                    alert('Please enter a customer name.');
                    return;
                }
                var customer = { id: customerId, name: customerName, products: [], low: 20, middle: 0.7, high: 0.75 };
                customers.push(customer);
                saveCustomerTable(customer);
                customerId++;
            }

            function handleXlsxUpload(e) {
                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = function (event) {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        if (workbook.SheetNames.length === 1) {
                            var sheet = workbook.Sheets[workbook.SheetNames[0]];    
                            var rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                            var docs = JSON.parse(JSON.stringify(rows, null, 2))
                            var customer = {id: customerId, name: "Unknown", products: [], low: 20, middle: 0.7, high: 0.75};
                            for (var i = 0; i < docs.length; i++) {
                                if (docs[i].length == 0) continue;
                                customer.products.push({title: docs[i][0], condition: docs[i][1], price: {}, photos: []});
                            }

                            saveCustomerTable(customer);
                            customers.push(customer);
                            refreshProducts(customerId);
                            customerId++;
                            return;
                        }
                        workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        if (sheetName == "Extra Data") {
                            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                            var data = JSON.parse(JSON.stringify(rows, null, 2))
                            const result = [];
                            let currentGroup = [];
                            for (const row of data) {
                                const isEmptyRow = row.every(cell => cell === '');
                                if (isEmptyRow) {
                                if (currentGroup.length > 0) {
                                    result.push(currentGroup);
                                    currentGroup = [];
                                }
                                } else {
                                    currentGroup.push(row);
                                }
                            }
                            // Add the last group if not empty
                            if (currentGroup.length > 0) {
                                result.push(currentGroup);
                            }
                            result.forEach((group) => {
                                if (group.length > 2) {
                                    console.log(group);
                                    var customer = {id: customerId, name: group[0][0], products: [], low: 20, middle: 0.7, high: 0.75};
                                    for (var i = 1; i < group.length - 1; i++) {
                                        if (group[i].length < 4) continue;
                                        customer.products.push({
                                            title: group[i][0],
                                            brand: group[i][1],
                                            condition: group[i][2],
                                            price: {
                                                display: group[i][3],
                                                amount: parseFloat(group[i][3].replace(/[^0-9.-]+/g, ""))
                                            },
                                            url: group[i][5] || '#',
                                            photos: [{_links: {thumbnail: {href: group[i][6] || ''}}}],
                                            hasPriceGuide: Boolean(group[i][7])
                                        });
                                    }
                                    saveCustomerTable(customer);
                                    customers.push(customer);
                                    customerId++;
                                }
                            })
                        }
                    });
                };
                reader.readAsArrayBuffer(file);
            }

            function saveCustomerTable(customer) {
                dashboard.innerHTML += `
                    <div id="customer${customer.id}" class="mb-4">
                        <h3>
                            <div class="d-flex align-items-center my-4">
                                <hr class="flex-grow-1 me-3">
                                <span style="font-weight: bold; color: #888; font-size: 1.1em; letter-spacing: 2px; white-space: nowrap; color: black;">
                                    <span id="customerNameDisplay${customer.id}">${customer.name}</span>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="editCustomerName(${customer.id})" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteCustomer(${customer.id})" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </span>
                                <hr class="flex-grow-1 ms-3">
                            </div>
                        </h3>
                        <textarea id="customerTextArea${customer.id}" class="form-control mb-2" placeholder="Please enter product name">Boss BR-1600CD Rectangle Push Button Covers (2 Buttons) UBOSS082, Very good</textarea>
                        <div style="margin-top: 20px">
                            <button class="btn btn-success mb-2" onclick="saveProducts(${customer.id})">Calculate Prices</button>
                            <button class="btn btn-danger mb-2" onclick="deleteSelectedRows(${customer.id})">Delete Selected</button>
                            <button class="btn btn-warning mb-2" onclick="deleteUnselectedRows(${customer.id})">Recalculate</button>
                            <button class="btn btn-secondary mb-2" onclick="resetProducts(${customer.id})">Reset</button>
                            <button class="btn btn-primary" onclick="refreshProducts(${customer.id})" style="float: right"><span class="glyphicon glyphicon-refresh"></span> Refresh</button>
                        </div>
                        <div class="filter-section">
                            <div class="d-flex align-items-center flex-wrap">
                                <label class="me-2 mb-0 fw-semibold">Filter Products:</label>
                                <div class="btn-group" role="group" id="priceGuideFilter${customer.id}">
                                    <input type="radio" class="btn-check" name="filter${customer.id}" id="filterAll${customer.id}" value="all" checked autocomplete="off" onchange="applyPriceGuideFilter(${customer.id})">
                                    <label class="btn btn-outline-primary" for="filterAll${customer.id}">All Products</label>
                                    
                                    <input type="radio" class="btn-check" name="filter${customer.id}" id="filterWithGuide${customer.id}" value="with" autocomplete="off" onchange="applyPriceGuideFilter(${customer.id})">
                                    <label class="btn btn-outline-success" for="filterWithGuide${customer.id}">✓ With Price Guide</label>
                                    
                                    <input type="radio" class="btn-check" name="filter${customer.id}" id="filterWithoutGuide${customer.id}" value="without" autocomplete="off" onchange="applyPriceGuideFilter(${customer.id})">
                                    <label class="btn btn-outline-danger" for="filterWithoutGuide${customer.id}">⚠ Without Price Guide</label>
                                </div>
                                <span class="filter-counter" id="filterCounter${customer.id}"></span>
                            </div>
                        </div>
                        <table id="customerTable${customer.id}" class="table table-bordered" style="margin-top: 10px">
                            <thead class="table-light">
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll${customer.id}" onchange="toggleSelectAll(${customer.id})" title="Select All">
                                    </th>
                                    <th>Image</th>
                                    <th>Title</th>
                                    <th>Brand</th>
                                    <th>Condition</th>
                                    <th>Price</th>
                                    <th>Adjusted Price</th>
                                    <th>Link</th>
                                    <th></th>
                                </tr>
                            </thead>
                        <tbody id="customerBody${customer.id}">
                            ${
                                customer.products
                                    .sort((a, b) => {
                                        if (a.hasPriceGuide === b.hasPriceGuide) return 0;
                                        return a.hasPriceGuide ? -1 : 1;
                                    })
                                    .map((item, i) => `
                                        ${addTBodyHtml(customer, item)}
                                    `).join('')
                            }
                        </tbody>
                        </table>
                        <!-- Pagination Controls -->
                        <div id="pagination${customer.id}" class="d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
                            <div class="d-flex align-items-center">
                                <label for="pageSize${customer.id}" class="form-label me-2 mb-0">Items per page:</label>
                                <select id="pageSize${customer.id}" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(${customer.id})">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="all">ALL</option>
                                </select>
                            </div>
                            <div class="d-flex align-items-center">
                                <span id="paginationInfo${customer.id}" class="text-muted me-3"></span>
                                <nav>
                                    <ul id="paginationNav${customer.id}" class="pagination pagination-sm mb-0">
                                        <!-- Pagination buttons will be generated here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                `;
            }

            function deleteCustomer(customerId) {
                if (!confirm("Are you sure you want to delete this customer?")) {
                    return;
                }
                var customerDiv = document.getElementById(`customer${customerId}`);
                if (customerDiv) {
                    dashboard.removeChild(customerDiv);
                }
                customers = customers.filter(c => c.id !== customerId);
            }

            function editCustomerName(customerId) {
                var customer = customers.find(c => c.id === customerId);
                if (!customer) return;
                
                var nameDisplay = document.getElementById(`customerNameDisplay${customerId}`);
                var currentName = customer.name;
                
                // Create input field
                var input = document.createElement('input');
                input.type = 'text';
                input.value = currentName;
                input.className = 'form-control form-control-sm';
                input.style = 'display: inline-block; width: auto; margin-right: 5px;';
                
                // Create save button
                var saveBtn = document.createElement('button');
                saveBtn.type = 'button';
                saveBtn.className = 'btn btn-success btn-sm';
                saveBtn.innerHTML = '<i class="bi bi-check"></i>';
                saveBtn.title = 'Save';
                saveBtn.onclick = function() {
                    var newName = input.value.trim();
                    if (newName) {
                        customer.name = newName;
                        nameDisplay.textContent = newName;
                        nameDisplay.style.display = 'inline';
                        input.remove();
                        saveBtn.remove();
                        cancelBtn.remove();
                    }
                };
                
                // Create cancel button
                var cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.className = 'btn btn-secondary btn-sm';
                cancelBtn.innerHTML = '<i class="bi bi-x"></i>';
                cancelBtn.title = 'Cancel';
                cancelBtn.onclick = function() {
                    nameDisplay.style.display = 'inline';
                    input.remove();
                    saveBtn.remove();
                    cancelBtn.remove();
                };
                
                // Replace display with input and buttons
                nameDisplay.style.display = 'none';
                nameDisplay.parentNode.insertBefore(input, nameDisplay.nextSibling);
                nameDisplay.parentNode.insertBefore(saveBtn, input.nextSibling);
                nameDisplay.parentNode.insertBefore(cancelBtn, saveBtn.nextSibling);
                
                // Focus on input and select text
                input.focus();
                input.select();
                
                // Handle Enter key
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        saveBtn.click();
                    }
                });
                
                // Handle Escape key
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        cancelBtn.click();
                    }
                });
            }

            var deletedRows = [];

            function deleteTableRows(customerId, rowId) {
                var button = document.querySelector(`button[data-row="${rowId}"]`);
                var customerBody = document.getElementById(`customerBody${customerId}`);
                var row = button.closest('tr');
                customerBody.removeChild(row);
                deletedRows.push(rowId);
                var customer = customers.find(c => c.id === customerId);
                if (customer) {
                    customer.products = customer.products.filter((_item, index) => _item.id != rowId.replace(`customer${customerId}delete`, ''));
                }
                // Note: Filter counter will be updated when products are refreshed
            }

            function saveProducts(customerId) {
                var textArea = document.getElementById(`customerTextArea${customerId}`);
                var text = textArea.value;
                if (!text) {
                    alert('Please enter product details.');
                    return;
                }
                const lines = text
                    .split(/\n|\r/)
                    .map((l) => l.trim())
                    .filter(Boolean);
                var pedals = [];
                for (let line of lines) {
                    const [name, condition] = line.split(",").map((s) => s && s.trim());
                    if (name)
                        pedals.push({ name, condition: condition || "Excellent" });
                }
                getProducts(customerId, pedals)
                // Make API request to backend
            }

            function getProducts(customerId, pedals, page = 1, pageSize = 10, toPage = false, priceGuideFilter = 'all') {
                var customerBody = document.getElementById(`customerBody${customerId}`);
                
                // Initialize pagination state for this customer
                if (!paginationState[customerId]) {
                    paginationState[customerId] = {
                        currentPage: 1,
                        pageSize: 10,
                        totalItems: 0,
                        totalPages: 0,
                        pedals: [],
                        priceGuideFilter: 'all'
                    };
                }
                
                // Update pagination state
                paginationState[customerId].currentPage = page;
                paginationState[customerId].pageSize = pageSize;
                paginationState[customerId].pedals = pedals;
                paginationState[customerId].priceGuideFilter = priceGuideFilter;
                
                // Show loading screen
                customerBody.innerHTML = `
                    <tr id="loadingRow">
                        <td colspan="9" class="text-center">
                            <div class="d-flex justify-content-center align-items-center">
                                <div class="spinner-border text-primary me-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="text-muted">Calculating prices...</span>
                            </div>
                        </td>
                    </tr>
                `;
                
                fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        pedals: JSON.stringify(pedals),
                        page: page,
                        limit: pageSize,
                        toPage: toPage,
                        priceGuideFilter: priceGuideFilter
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Remove loading screen
                    var loadingRow = document.getElementById('loadingRow');
                    if (loadingRow) {
                        loadingRow.remove();
                    }
                    
                    if (data && data.products && Array.isArray(data.products)) {
                        var customer = customers.find(c => c.id === customerId);
                        if (document.getElementById('noData') !== null) customerBody.removeChild(document.getElementById('noData'));
                        
                        // Clear existing products for this page
                        customer.products = customer.products.filter(p => p.page !== page);
                        
                        // Process products and add hasPriceGuide flag (backend already sorted them)
                        data.products.forEach((item, i) => {
                            item.hasPriceGuide = false;
                            var price = item.price
                            if (item.priceGuide && item.priceGuide.length > 0) {
                                item.hasPriceGuide = true
                                var priceGuide = item.priceGuide.reduce((acc, curr) => acc + curr.amount, 0);
                                priceGuide = priceGuide / item.priceGuide.length;
                                price = {
                                    amount: priceGuide,
                                    display: '$' + priceGuide.toFixed(2)
                                }
                            }
                            var product = {
                                id: item.id,
                                productId: item.productId || '',
                                title: item.title || '',
                                brand: item.title.split(" ")[0] || '',
                                condition: item.condition.display_name || '',
                                price,
                                displayPrice: item.price.display || '',
                                url: item.url ? item.url : '#',
                                photos: item.photos || [],
                                page: page,
                                hasPriceGuide: item.hasPriceGuide
                            };
                            customer.products.push(product);
                            customerBody.innerHTML += addTBodyHtml(customer, product);
                        });
                        
                        // Update pagination state
                        paginationState[customerId].totalItems = data.pagination.totalItems;
                        paginationState[customerId].totalPages = data.pagination.totalPages;
                        
                        // Store statistics from backend
                        if (data.statistics) {
                            paginationState[customerId].statistics = data.statistics;
                        }
                        
                        // Update pagination controls
                        updatePaginationControls(customerId);
                        
                        // Update filter counter with backend statistics
                        updateFilterCounterFromStats(customerId, data.statistics);
                        
                        // Show pagination controls (even with 1 page, to allow switching between ALL and paginated view)
                        var paginationDiv = document.getElementById(`pagination${customerId}`);
                        if (data.pagination.totalItems > 0) {
                            paginationDiv.style.display = 'flex';
                        } else {
                            paginationDiv.style.display = 'none';
                        }
                        
                        var textArea = document.getElementById(`customerTextArea${customerId}`);
                        textArea.value = '';
                    } else {
                        customerBody.innerHTML = '<tr id="noData"><td colspan="9" class="text-center">No Data</td></tr>';
                        var paginationDiv = document.getElementById(`pagination${customerId}`);
                        paginationDiv.style.display = 'none';
                    }
                })
                .catch((err) => {
                    console.log(err)
                    // Remove loading screen and show error
                    var loadingRow = document.getElementById('loadingRow');
                    if (loadingRow) {
                        loadingRow.remove();
                    }
                    customerBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading data</td></tr>';
                    var paginationDiv = document.getElementById(`pagination${customerId}`);
                    paginationDiv.style.display = 'none';
                });
            }

            function getAdjustPrice(customer, item) {
                var base = item.price.amount || 0;
                var adjusted = base;
                if (base < customer.low) return base;
                if (base <= 69 && base >= customer.low) {
                    adjusted = customer.low;
                } else if (base >= 70 && base <= 199) {
                    adjusted = Math.round(base * customer.middle);
                } else if (base >= 199) {
                    adjusted = Math.round(base * customer.high);
                }
                return adjusted;
            }

            function addTBodyHtml(customer, item) {
                // Get image URL from photos array if available
                let imageUrl = "";
                if (item.photos && item.photos.length > 0 && item.photos[0]._links) {
                    // Prefer thumbnail, fallback to small_crop, then full
                    imageUrl = item.photos[0]._links.thumbnail?.href || 
                             item.photos[0]._links.small_crop?.href || 
                             item.photos[0]._links.full?.href || "";
                }
                console.log(item.hasPriceGuide)
                return `
                    <tr data-has-price-guide="${item.hasPriceGuide || false}">
                        <td>
                            <input type="checkbox" class="productCheckbox" data-row="customer${customer.id}delete${item.id}" data-customer-id="${customer.id}" data-product-id="${item.id}">
                        </td>
                        <td>${imageUrl ? `<img src="${imageUrl}" alt="${item.title}" class="product-image">` : '<span class="no-image">No image</span>'}</td>
                        <td>${item.title || ''}</td>
                        <td>${item.title.split(" ")[0] || ''}</td>
                        <td>${typeof(item.condition) == "string" ? item.condition : item.condition.display_name}</td>
                        <td style="min-width: 140px;">
                            ${item.hasPriceGuide !== undefined ? 
                                `<span class="price-flag ${item.hasPriceGuide ? 'has-guide' : 'no-guide'}" title="${item.hasPriceGuide ? 'Has price guide data' : 'No price guide data'}"></span>` : 
                                ''
                            }
                            <span>${item.price.display || ''}</span>
                        </td>
                        <td>$${getAdjustPrice(customer, item)}</td>
                        <td><a href="${item.url ? item.url : '#'}" target="_blank">Link</a></td>
                        <td style="text-align: center">
                            <button type="button" data-row="customer${customer.id}delete${item.id}" class="btn btn-danger btn-sm" onclick="deleteTableRows(${customer.id}, 'customer${customer.id}delete${item.id}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `
            }
            
            function updateFilterCounterFromStats(customerId, statistics) {
                if (!statistics) return;
                
                var counterElement = document.getElementById(`filterCounter${customerId}`);
                if (counterElement) {
                    counterElement.innerHTML = `
                        <span>Total: <strong>${statistics.totalAll}</strong></span>
                        <span class="ms-2 text-success">✓ With Guide: <strong>${statistics.totalWithPriceGuide}</strong></span>
                        <span class="ms-2 text-danger">⚠ Without Guide: <strong>${statistics.totalWithoutPriceGuide}</strong></span>
                    `;
                }
            }
            
            function applyPriceGuideFilter(customerId) {
                var state = paginationState[customerId];
                if (!state || !state.pedals || state.pedals.length === 0) {
                    alert('Please load products first before applying filters.');
                    return;
                }
                
                // Get selected filter value
                var filterValue = document.querySelector(`input[name="filter${customerId}"]:checked`).value;
                
                // Clear existing products and reload from backend with the filter
                var customer = customers.find(c => c.id === customerId);
                if (customer) {
                    customer.products = [];
                }
                
                // Reload products with the new filter, starting from page 1
                getProducts(customerId, state.pedals, 1, state.pageSize, true, filterValue);
            }
            function refreshProducts(customerId) {
                var customer = customers.find(c => c.id === customerId);
                if (customer && Array.isArray(customer.products) && customer.products.length > 0) {
                    let pedals = customer.products.map(product => ({ name: product.title, condition: product.condition }));
                    var customerBody = document.getElementById(`customerBody${customerId}`);
                    
                    // Show loading screen
                    customerBody.innerHTML = `
                        <tr id="loadingRow">
                            <td colspan="9" class="text-center">
                                <div class="d-flex justify-content-center align-items-center">
                                    <div class="spinner-border text-primary me-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="text-muted">Refreshing prices...</span>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    customer.products = [];
                    // Reset pagination state
                    if (paginationState[customerId]) {
                        paginationState[customerId].currentPage = 1;
                    }
                    var currentFilter = paginationState[customerId]?.priceGuideFilter || 'all';
                    getProducts(customerId, pedals, 1, paginationState[customerId]?.pageSize || 10, false, currentFilter);
                }
            }
            
            function resetProducts(customerId) {
                if (!confirm("Are you sure you want to reset all products for this customer? This will clear all existing products and cannot be undone.")) {
                    return;
                }
                
                var customer = customers.find(c => c.id === customerId);
                if (!customer) return;
                
                var customerBody = document.getElementById(`customerBody${customerId}`);
                var paginationDiv = document.getElementById(`pagination${customerId}`);
                
                // Clear all products from customer data
                customer.products = [];
                
                // Clear the table body
                customerBody.innerHTML = '<tr id="noData"><td colspan="9" class="text-center">No products loaded</td></tr>';
                
                // Hide pagination
                paginationDiv.style.display = 'none';
                
                // Reset pagination state
                if (paginationState[customerId]) {
                    paginationState[customerId].currentPage = 1;
                    paginationState[customerId].totalItems = 0;
                    paginationState[customerId].totalPages = 0;
                }
                updatePaginationControls(customerId);
                
                // Clear the textarea
                var textArea = document.getElementById(`customerTextArea${customerId}`);
                if (textArea) {
                    textArea.value = '';
                }
                
                // Reset select all checkbox
                var selectAllCheckbox = document.getElementById(`selectAll${customerId}`);
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
            }
            
            // Pagination control functions
            function updatePaginationControls(customerId) {
                var state = paginationState[customerId];
                if (!state) return;
                
                var paginationInfo = document.getElementById(`paginationInfo${customerId}`);
                var paginationNav = document.getElementById(`paginationNav${customerId}`);
                var pageSizeSelect = document.getElementById(`pageSize${customerId}`);
                
                // Update pagination info
                var startItem = (state.currentPage - 1) * state.pageSize + 1;
                var endItem = Math.min(state.currentPage * state.pageSize, state.totalItems);
                
                // Check if we're showing all items (when pageSize is very large or equals/exceeds totalItems)
                if (state.pageSize >= state.totalItems || state.pageSize >= 999999) {
                    paginationInfo.textContent = `Showing all ${state.totalItems} items`;
                } else {
                    paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${state.totalItems} items`;
                }
                
                // Update page size select
                if (state.pageSize >= 999999) {
                    pageSizeSelect.value = 'all';
                } else {
                    pageSizeSelect.value = state.pageSize;
                }
                
                // Generate pagination buttons (only if not showing all items)
                var paginationHtml = '';
                var isShowingAll = state.pageSize >= state.totalItems || state.pageSize >= 999999;
                
                if (!isShowingAll && state.totalPages > 1) {
                    // Previous button
                    if (state.currentPage > 1) {
                        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${customerId}, ${state.currentPage - 1})">Previous</a></li>`;
                    } else {
                        paginationHtml += `<li class="page-item disabled"><span class="page-link">Previous</span></li>`;
                    }
                    
                    // Page numbers
                    var startPage = Math.max(1, state.currentPage - 2);
                    var endPage = Math.min(state.totalPages, state.currentPage + 2);
                    
                    if (startPage > 1) {
                        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${customerId}, 1)">1</a></li>`;
                        if (startPage > 2) {
                            paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                    }
                    
                    for (var i = startPage; i <= endPage; i++) {
                        if (i === state.currentPage) {
                            paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                        } else {
                            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${customerId}, ${i})">${i}</a></li>`;
                        }
                    }
                    
                    if (endPage < state.totalPages) {
                        if (endPage < state.totalPages - 1) {
                            paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${customerId}, ${state.totalPages})">${state.totalPages}</a></li>`;
                    }
                    
                    // Next button
                    if (state.currentPage < state.totalPages) {
                        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${customerId}, ${state.currentPage + 1})">Next</a></li>`;
                    } else {
                        paginationHtml += `<li class="page-item disabled"><span class="page-link">Next</span></li>`;
                    }
                }
                
                paginationNav.innerHTML = paginationHtml;
            }
            
            function goToPage(customerId, page) {
                var state = paginationState[customerId];
                if (!state || page < 1 || page > state.totalPages) return;
                
                getProducts(customerId, state.pedals, page, state.pageSize, true, state.priceGuideFilter || 'all');
            }
            
            function changePageSize(customerId) {
                var pageSizeSelect = document.getElementById(`pageSize${customerId}`);
                var selectedValue = pageSizeSelect.value;
                var newPageSize;
                
                // Handle "ALL" option by setting a very large page size
                if (selectedValue === 'all') {
                    newPageSize = 999999; // Large number to get all items
                } else {
                    newPageSize = parseInt(selectedValue);
                }
                
                var state = paginationState[customerId];
                
                if (!state) return;
                
                // Reset to page 1 when changing page size
                getProducts(customerId, state.pedals, 1, newPageSize, false, state.priceGuideFilter || 'all');
            }

            function toggleSelectAll(customerId) {
                const selectAllCheckbox = document.getElementById(`selectAll${customerId}`);
                const productCheckboxes = document.querySelectorAll(`#customerTable${customerId} tbody tr .productCheckbox`);
                productCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                    updateRowSelection(checkbox);
                });
            }

            function updateRowSelection(checkbox) {
                const row = checkbox.closest('tr');
                if (checkbox.checked) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            }

            // Add event listeners for individual checkboxes
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('productCheckbox')) {
                    updateRowSelection(e.target);
                    
                    // Update select all checkbox
                    const customerId = e.target.dataset.customerId;
                    const productCheckboxes = document.querySelectorAll(`#customerTable${customerId} tbody tr .productCheckbox`);
                    const selectAllCheckbox = document.getElementById(`selectAll${customerId}`);
                    
                    if (selectAllCheckbox) {
                        const allChecked = Array.from(productCheckboxes).every(checkbox => checkbox.checked);
                        const anyChecked = Array.from(productCheckboxes).some(checkbox => checkbox.checked);
                        
                        selectAllCheckbox.checked = allChecked;
                        selectAllCheckbox.indeterminate = anyChecked && !allChecked;
                    }
                }
            });

            function deleteUnselectedRows(customerId) {
                const productCheckboxes = document.querySelectorAll(`#customerTable${customerId} tbody tr .productCheckbox`);
                const unselectedRows = Array.from(productCheckboxes).filter(checkbox => !checkbox.checked);
                
                if (unselectedRows.length === 0) {
                    alert('No unselected rows to delete.');
                    return;
                }

                if (!confirm(`Are you sure you want to delete ${unselectedRows.length} unselected rows?`)) {
                    return;
                }

                // Get the customer data
                const customer = customers.find(c => c.id === customerId);
                if (!customer) return;

                // Remove unselected rows from DOM and update customer data
                unselectedRows.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const productId = checkbox.dataset.productId;
                    
                    // Remove from DOM
                    row.remove();
                    
                    // Remove from customer products array
                    customer.products = customer.products.filter(product => product.id != productId);
                    
                    // Add to deleted rows array
                    deletedRows.push(`customer${customerId}delete${productId}`);
                });

                // Note: Filter counter will be updated when products are refreshed

                // Reset select all checkbox since we're keeping only selected items
                const selectAllCheckbox = document.getElementById(`selectAll${customerId}`);
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = true;
                }
            }

            function deleteSelectedRows(customerId) {
                const productCheckboxes = document.querySelectorAll(`#customerTable${customerId} tbody tr .productCheckbox`);
                const selectedRows = Array.from(productCheckboxes).filter(checkbox => checkbox.checked);
                
                if (selectedRows.length === 0) {
                    alert('No rows selected for deletion.');
                    return;
                }

                if (!confirm(`Are you sure you want to delete ${selectedRows.length} selected rows?`)) {
                    return;
                }

                // Get the customer data
                const customer = customers.find(c => c.id === customerId);
                if (!customer) return;

                // Remove selected rows from DOM and update customer data
                selectedRows.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const productId = checkbox.dataset.productId;
                    
                    // Remove from DOM
                    row.remove();
                    
                    // Remove from customer products array
                    customer.products = customer.products.filter(product => product.id != productId);
                    
                    // Add to deleted rows array
                    deletedRows.push(`customer${customerId}delete${productId}`);
                });

                // Note: Filter counter will be updated when products are refreshed

                // Reset select all checkbox
                const selectAllCheckbox = document.getElementById(`selectAll${customerId}`);
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
            }


            function downloadExcel() {
                var sheets1 = [["Customer Name", "Total Price"]], sheets2 = [];
                customers.forEach((customer) => {
                    sheets2.push([customer.name, "Brand", "Condition", "Price", "Adjusted Price", "Link", "Photo"])
                    var totalPrice = 0;
                    customer.products.forEach((product) => {
                        sheets2.push([
                            product.title,
                            product.brand,
                            product.condition,
                            product.price.display || '$0',
                            getAdjustPrice(customer, product) || '$0',
                            product.url,
                            product.photos.length > 0 ? product.photos[0]._links.thumbnail.href : '',
                            product.hasPriceGuide
                        ]);
                        totalPrice += product.price.amount
                    });
                    var offer = 0;
                    if (totalPrice <= 69) {
                        offer = customer.low;
                    } else if (totalPrice >= 70 && totalPrice <= 199) {
                        offer = customer.middle;
                    } else if (totalPrice >= 200) {
                        offer = customer.high;
                    }
                    sheets2.push(["Total Fair Market Value", "$" + totalPrice]);
                    sheets2.push([`Total Offer (FMV * ${offer * 100}%)`, "$" + getAdjustPrice(customer, {price: {amount: totalPrice}})]);
                    sheets2.push(["", "", "", "", "", ""]);
                    sheets1.push([customer.name, "$" + totalPrice]);
                })
                const sheet1 = XLSX.utils.aoa_to_sheet(sheets1);
                const sheet2 = XLSX.utils.aoa_to_sheet(sheets2);
                // Create workbook and add sheets
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, sheet1, "Customers");
                XLSX.utils.book_append_sheet(workbook, sheet2, "Extra Data");
                let now = new Date();
                let pad = (n) => n.toString().padStart(2, "0");
                let datetime = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(
                    now.getDate()
                )}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(
                    now.getSeconds()
                )}`;
                XLSX.writeFile(workbook, "multi-sheet " + datetime + ".xlsx");
            }
        </script>
    </body>
</html>